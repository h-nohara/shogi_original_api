ここではjavascript中の動作構造を説明します

# HistoryHandlerと履歴表示について

## 描画までの流れ

history描画のフローは以下のとおり

１、オリジナルのhistory（オリジナル）
２、１を元に、今回表示する履歴を１つのリストにまとめる（リスト）
３、d3.jsに２を与えて描画（ドム）

何らかのアクションがあると、

ドムが参照しているデータ（リスト中のアクション）を通じて、オリジナルに変更を加える
→　変更されたオリジナルを元にリストを０から作り直す
→　リストを元に描画を０から作り直す

という流れでhistory viewを更新します。


## ２のリスト関数について

オリジナルはサブシナリオが入り組んだ分岐構造になっているため、現在描画する部分だけをまとめたリストを作成する必要があります。


### parentの設定

リストに加えられる各アクションは["parent"]と["order_in_parent"]を自動で設定されます。
["parent"]はオリジナルのシナリオへの参照となっており、これを操作することで、オリジナルに対して変更が加えられるようになっています。

## watching_action, watching_dom, 背景色について

・アクションに"is_watching"キーをセット＋trueなら描画時に色を青に
・クリック時とアクション追加時：
        元のアクション："is_watching"をfalseに＋背景色を色に戻す
        クリックされたアクション：History.watching_action, History.watching_domをこれに上書き＋背景を青に（クリック時はdomを直接変更、追加時は"is_waching"で描画時に青に）
        

## scenarioアクション（ブランチ）について

### サブシナリオの表示

```History.watching_action```を常に監視しておき、シナリオアクションになっていたら表示。
表示については、サブシナリオをd3.jsに与えてあり、各サブシナリオの先頭アクションを元に表示文字を決めている。
クリックされたらそれが何番目のシナリオかd3.js中で取得　→　シナリオアクションの"selected_scenario"の番号をそれに更新。


##  load, saveについて

### parentの設定

 action["parent"]は再帰参照になっているので、
１、サーバに渡す際は["parent"]を削除
２、サーバから読み込む際は["parent"]を設定し直し

### "+"の対策

サーバに渡すと文字列中の"+"が抜けてしまうので、対策をしている

